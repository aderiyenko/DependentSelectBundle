{% block dependent_filtered_entity_widget %}
    <script type="text/javascript">
      if (typeof jQuery.ui == 'undefined') {
        jQuery.getScript('{{ asset('/bundles/dependentselect/js/jqueryui/jquery-ui-1.10.1.custom.min.js') }}');
      }

    </script>
    <link rel="stylesheet" href="{{ asset('bundles/dependentselect/css/jqueryui/jquery-ui-1.10.1.custom.min.css') }}"/>
    <link rel="stylesheet" href="{{ asset('bundles/dependentselect/css/jqueryui/jquery-ui-autocomplete-1.10.1.custom.min.css') }}"/>
    <select {{ block('widget_attributes') }}></select>

    <script type="text/javascript">
        jQuery(function(){

            jQuery("select#{{ form.parent.offsetGet( parent_field ).vars.id }}").change( function() {
                var selected_index = {{ value ? value : 0 }};
                jQuery("select#{{ form.vars.id }}").attr('disabled','true');
                jQuery.ajax({
                    type: "POST",
                    data: {
                        parent_id: jQuery(this).val(),
                        {% if fallback_parent_field is not null %}
                        fallback_parent_id: jQuery("#{{ form.parent.offsetGet( fallback_parent_field ).vars.id }}").val(),
                        {% endif %}
                        entity_alias: "{{ entity_alias }}",
                        empty_value: "{{ empty_value }}",
                        excluded_entity_id: "{{ excluded_entity_id }}",
                        choice_translation_domain: "{{ choice_translation_domain }}",
                        choice_title_translation_part: "{{ choice_title_translation_part }}",
                        callback_parameters: '{{ callback_parameters|json_encode|raw }}'
                    },
                    url:"{{ path('dependent_select') }}",
                    success: function(msg){
                        var count = msg.count || 0;
                        if(!count) {
                            jQuery("select#{{ form.vars.id }}").html('<em>{{ no_result_msg|trans() }}</em>');
                        } else if (count && count <= msg.max_number_of_items) {
                            jQuery.each(msg.data, function (i, item) {
                                jQuery("select#{{ form.vars.id }}").append('<option value="' + item.id + '">' + item.value + '</option>');

                                jQuery.each(jQuery("select#{{ form.vars.id }} option"), function (index, option) {
                                    if (jQuery(option).val() == selected_index) {
                                      jQuery(option).prop('selected', true);
                                    }
                                });
                                jQuery("select#{{ form.vars.id }}").trigger('change');
                                jQuery("#loader").hide();
                            });
                        } else {
                            jQuery("select#{{ form.vars.id }}").replaceWith('<input type="text" id="{{ form.vars.id }}_text"/><input type="hidden" value = "" id = "{{ form.vars.id }}" name = "form[{{ form.vars.name }}]" > ');
                            jQuery("input#{{ form.vars.id }}_text").autocomplete({
                                source: function (request, response) {
                                    var re = $.ui.autocomplete.escapeRegex(request.term);
                                    var matcher = new RegExp(re, "i");
                                    var a = jQuery.grep(msg.data, function (item, index) {
                                        return matcher.test(item.value);
                                    });

                                    response(jQuery.map(a, function (item) {
                                        return {
                                            label: item.value,
                                            value: item.id
                                        }
                                    }));
                                },
                                minLength: 2,
                                open: function () {
                                    jQuery(this).removeClass("ui-corner-all").addClass("ui-corner-top");
                                },
                                close: function () {
                                    jQuery(this).removeClass("ui-corner-top").addClass("ui-corner-all");
                                },
                                select: function (event, ui) {
                                    jQuery("#{{ form.vars.id }}_text").val(ui.item.label);
                                    jQuery("#{{ form.vars.id }}").val(ui.item.value);

                                    return false;
                                }
                            });
                        }
                      jQuery("select#{{ form.vars.id }}").removeAttr('disabled');
                    },
                    error: function(xhr, ajaxOptions, thrownError){
                        jQuery('html').html(xhr.responseText);
                        jQuery("select#{{ form.vars.id }}").removeAttr('disabled');
                    }
                });
            });

            jQuery("select#{{ form.parent.offsetGet( parent_field ).vars.id }}").trigger('change');
        });
    </script>

{% endblock %}
